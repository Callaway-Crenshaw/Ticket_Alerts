name: Scheduled Alert Runner

on:
  workflow_dispatch:
  schedule:
    # Running every 15 minutes, Mon-Fri (1-5) UTC
    - cron: '*/15 * * * 1-5' 

jobs:
  ci_pipeline:
    runs-on: ubuntu-latest
    
    # Enable read/write permissions for the GitHub token so we can update the variable
    permissions:
      contents: read
      actions: write # Required for `github.request` to update the variable
      variables: write # Explicitly required to update repository variables

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      # 1. Configure Environment File (Safely writing config.py)
      - name: Configure Environment File
        shell: bash 
        run: |
          # Writes the entire secret content (FULL_CONFIG_SECRETS) into config.py
          cat << EOF > config.py
          ${{ secrets.FULL_CONFIG_SECRETS }}
          EOF

      # 2. RUN SCRIPT & CAPTURE OUTPUT (Step ID: alert_run)
      # The Python script reads LAST_RUN_ID from the environment and prints the new highest ID.
      - name: Run ConnectWise Alert Script
        id: alert_run # IMPORTANT: Gives this step an ID to capture output
        run: python connectwise_alert.py
        env:
          # CRITICAL: Inject the LAST_RUN_ID variable into the script's environment
          LAST_RUN_ID: ${{ vars.LAST_RUN_ID }}

      # 3. SAVE OUTPUT BACK TO REPOSITORY VARIABLE
      - name: Save new LAST_RUN_ID for next run
        # Only run this step if the previous step successfully produced a 'next_id' output
        if: steps.alert_run.outputs.next_id != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const newId = '${{ steps.alert_run.outputs.next_id }}';
            console.log(`Saving new persistent ID: ${newId}`);
            
            // This API call updates the repository variable
            await github.request('PATCH /repos/{owner}/{repo}/actions/variables/{name}', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'LAST_RUN_ID', // Must match the variable name you created
              value: newId,
            });
