# .github/workflows/alert_script.yml

name: ConnectWise Ticket Alert

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  run_alert_script:
    runs-on: ubuntu-latest
    
    # 1. Fetch the simple LAST_RUN_ID variable directly
    env:
      LAST_RUN_ID: ${{ vars.LAST_RUN_ID }} # Retrieves the current '0' or last saved ID

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”‘ Set Environment Variables (Secrets)
        id: set_secrets
        run: |
          # The corrected secret format allows for a simpler, direct read.
          echo "Setting environment variables from FULL_CONFIG_SECRETS..."
          echo "${{ secrets.FULL_CONFIG_SECRETS }}" >> "$GITHUB_ENV"
        shell: bash
      - name: ðŸš€ Run Python Alert Script
        id: run_script
        run: python connectwise_alert.py
        shell: bash

      # 2. Save the 'next_id' output from the script back to the variable
      - name: ðŸ’¾ Save Last Processed ID for Next Run
        if: steps.run_script.outputs.next_id != '' # Only run if the script successfully set an ID
        uses: actions/github-script@v7
        with:
          script: |
            const newId = steps.run_script.outputs.next_id;
            
            // Save the new ID back to the LAST_RUN_ID repository variable
            await github.rest.actions.updateVariable({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'LAST_RUN_ID', # Target the simple variable
              value: newId
            });
            console.log(`Updated LAST_RUN_ID repository variable to ${newId}`);
