# .github/workflows/alert_script.yml

name: ConnectWise Ticket Alert

# Run every 15 minutes
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  run_alert_script:
    runs-on: ubuntu-latest
    
    # 1. Fetch the simple LAST_RUN_ID variable directly
    env:
      LAST_RUN_ID: ${{ vars.LAST_RUN_ID }} # Retrieves the current '0' or last saved ID

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # Install Python dependencies (removed for brevity, but include in your file)
      # - name: ðŸ Set up Python
      #   uses: actions/setup-python@v5
      # ... install dependencies ...

      - name: ðŸ”‘ Set Environment Variables (Secrets)
        id: set_secrets
        run: |
          # The corrected secret format allows for a simpler, direct read.
          echo "Setting environment variables from FULL_CONFIG_SECRETS..."
          echo "${{ secrets.FULL_CONFIG_SECRETS }}" >> "$GITHUB_ENV"
        shell: bash
        
      - name: ðŸš€ Run Python Alert Script
        id: run_script
        run: python connectwise_alert.py
        shell: bash

      ---

      # 2. Save the 'next_id' output from the script back to the variable (FIXED)
      - name: ðŸ’¾ Save Last Processed ID for Next Run
        # Only run if the script successfully set an ID and the step passed
        if: ${{ success() && steps.run_script.outputs.next_id != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            // FIX: Wrap the output in single quotes to ensure it is always a safe JS string literal.
            const newId = '${{ steps.run_script.outputs.next_id }}';
            
            console.log(`Attempting to save ID: ${newId}`);
            
            // Save the new ID back to the LAST_RUN_ID repository variable
            await github.rest.actions.updateVariable({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'LAST_RUN_ID', // Target the simple variable
              value: newId
            });
            console.log(`âœ… Successfully updated LAST_RUN_ID repository variable to ${newId}.`);
