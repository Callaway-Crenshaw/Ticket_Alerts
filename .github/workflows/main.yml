.github/workflows/alert_script.yml

name: ðŸŽ« ConnectWise Ticket Alert

Run every 15 minutes

on:
schedule:
- cron: '*/15 * * * *'
workflow_dispatch:

jobs:
run_alert_script:
runs-on: ubuntu-latest

# Permission for committing a file change
# NOTE: The file-based persistence requires 'contents: write' permission.
permissions:
  contents: write 

# No longer using 'vars.LAST_RUN_ID' here as we read from a file.

steps:
  - name: â¬‡ï¸ Checkout Repository
    uses: actions/checkout@v4
    with:
      fetch-depth: 0 # Set to 0 to perform a full clone. This helps bypass
                     # transient 500 errors related to fetching shallow history.

  # --- NEW STEP: Read the Last ID from the File ---
  - name: âš™ï¸ Read LAST_RUN_ID from File
    id: read_id
    # Use actions/github-script to read the file content and set it as an output
    uses: actions/github-script@v7
    with:
      script: |
        const fs = require('fs');
        try {
          // Read the content of the file
          const lastId = fs.readFileSync('last_run_id.txt', 'utf8').trim();
          console.log(`Read ID from file: ${lastId}`);
          // Set the output for use in the environment block
          core.setOutput('id', lastId);
        } catch (error) {
          // If the file doesn't exist (first run), default to 0
          console.log("last_run_id.txt not found. Defaulting to 0.");
          core.setOutput('id', '0');
        }
      # This token is needed for the script environment, but not for file I/O
      github-token: ${{ secrets.GITHUB_TOKEN }}

  # --- Use the ID read from the file ---
  - name: ðŸ”‘ Set Environment Variables (LAST_RUN_ID)
    env:
      # Use the output from the previous step to set the environment variable
      LAST_RUN_ID: ${{ steps.read_id.outputs.id }}
    run: |
      echo "LAST_RUN_ID=${{ steps.read_id.outputs.id }}" >> $GITHUB_ENV
      echo "Current LAST_RUN_ID set to ${{ steps.read_id.outputs.id }} for Python script."

  - name: ðŸ Set up Python 3.x
    uses: actions/setup-python@v5
    with:
      python-version: '3.x'

  - name: ðŸ“¦ Install Dependencies
    run: |
      python -m pip install --upgrade pip
      pip install requests 

  - name: ðŸ”‘ Set Environment Variables (Secrets)
    run: |
      echo "Setting environment variables from FULL_CONFIG_SECRETS..."
      echo "${{ secrets.FULL_CONFIG_SECRETS }}" >> "$GITHUB_ENV"
    shell: bash
    
  - name: ðŸš€ Run Python Alert Script
    id: run_script
    run: python connectwise_alert.py
    shell: bash

  # --- NEW STEP: Commit the File Change ---
  - name: ðŸ’¾ Commit Last Processed ID File
    # Python script MUST have updated 'last_run_id.txt' before this step runs
    if: ${{ success() && steps.run_script.outputs.next_id != '' }}
    uses: stefanzweifel/git-auto-commit-action@v5
    with:
      token: ${{ secrets.GITHUB_TOKEN }}
      # The file created/updated by the Python script
      commit_message: 'ci: Update LAST_RUN_ID to ${{ steps.run_script.outputs.next_id }}'
      files: last_run_id.txt
      branch: main # CHANGE TO 'master' or your default branch name if different
      allow_empty: false
