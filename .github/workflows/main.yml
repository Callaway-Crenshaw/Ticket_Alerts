# .github/workflows/alert_script.yml

name: üé´ ConnectWise Ticket Alert

# Run every 15 minutes
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  run_alert_script:
    runs-on: ubuntu-latest
    
    # üí• FINAL PERMISSIONS FIX: Requesting explicit 'actions: write' permission üí•
    permissions:
      contents: read  # Still need read access for checkout
      actions: write  # Explicitly grant write access for variables endpoint
    
    # 1. Fetch the simple LAST_RUN_ID variable directly
    env:
      LAST_RUN_ID: ${{ vars.LAST_RUN_ID }}

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Set up Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests 

      - name: üîë Set Environment Variables (Secrets)
        id: set_secrets
        run: |
          echo "Setting environment variables from FULL_CONFIG_SECRETS..."
          echo "${{ secrets.FULL_CONFIG_SECRETS }}" >> "$GITHUB_ENV"
        shell: bash
        
      - name: üöÄ Run Python Alert Script
        id: run_script
        run: python connectwise_alert.py
        shell: bash

      - name: üíæ Save Last Processed ID for Next Run
        if: ${{ success() && steps.run_script.outputs.next_id != '' }}
        uses: actions/github-script@v7
        with:
          # ‚ö†Ô∏è WARNING FIX: Changed 'token' to 'github-token'
          github-token: ${{ secrets.GITHUB_TOKEN }} 
          
          script: |
            const newId = '${{ steps.run_script.outputs.next_id }}';
            
            console.log(`Attempting to save ID: ${newId}`);
            
            // Function updateRepoVariable is correct (fixes the TypeError)
            await github.rest.actions.updateRepoVariable({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'LAST_RUN_ID',
              value: newId
            });
            console.log(`‚úÖ Successfully updated LAST_RUN_ID repository variable to ${newId}.`);
