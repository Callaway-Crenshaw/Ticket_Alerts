# .github/workflows/alert_script.yml

name: ðŸŽ« ConnectWise Ticket Alert

# Run every 15 minutes
on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  run_alert_script:
    runs-on: ubuntu-latest
    
    # This block must use 2-space indentation
    permissions:
      contents: read
      variables: write 
    
    env:
      LAST_RUN_ID: ${{ vars.LAST_RUN_ID }}

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests smtplib email-message

      - name: ðŸ”‘ Set Environment Variables (Secrets)
        id: set_secrets
        run: |
          echo "Setting environment variables from FULL_CONFIG_SECRETS..."
          echo "${{ secrets.FULL_CONFIG_SECRETS }}" >> "$GITHUB_ENV"
        shell: bash
        
      - name: ðŸš€ Run Python Alert Script
        id: run_script
        run: python connectwise_alert.py
        shell: bash

      - name: ðŸ’¾ Save Last Processed ID for Next Run
        if: ${{ success() && steps.run_script.outputs.next_id != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const newId = '${{ steps.run_script.outputs.next_id }}';
            
            console.log(`Attempting to save ID: ${newId}`);
            
            await github.rest.actions.updateVariable({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'LAST_RUN_ID',
              value: newId
            });
            console.log(`âœ… Successfully updated LAST_RUN_ID repository variable to ${newId}.`);
